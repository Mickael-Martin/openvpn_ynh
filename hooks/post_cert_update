#!/bin/bash
source /usr/share/yunohost/helpers
source _common.sh

app=$1
domain=$2

installedDomain=$(ynh_app_setting_get $app domain)
if [ "$domain" == "$installedDomain" ];then
   isLE=$(yunohost domain cert-status $domain | grep -c "CA_type: Let's Encrypt")
   if [ $isLE -eq 1 ];then
      mkdir /etc/openvpn/certs/
      chown -R $app: /etc/openvpn/certs/
      openssl crl2pkcs7 -nocrl -certfile /etc/yunohost/certs/$domain/crt.pem | openssl pkcs7 -print_certs| awk -v RS='' '{print > ("/etc/openvpn/certs/cert-" NR ".txt")}'
      mv /etc/openvpn/certs/cert-1.txt /etc/openvpn/certs/cert-$domain.pem
      mv /etc/openvpn/certs/cert-2.txt /etc/openvpn/certs/cachain-$domain.pem 
      cat /etc/ssl/certs/DST_Root_CA_X3.pem >>/etc/openvpn/certs/cachain-$domain.pem
      systemctl openvpn restart
      ynh_configure config.ovpn "${local_path}/${domain}.conf"
      ynh_configure config-cli.ovpn "${local_path}/${domain}.ovpn"
   fi
fi
